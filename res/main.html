<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
    <title>UltASeqAn Result Visualization</title>
    <link rel="stylesheet" type="text/css" href="lib/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="lib/css/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="lib/jqwidgets/styles/jqx.base.css" />
    <link rel="stylesheet" type="text/css" href="css/styles.css"/>
    <link rel="stylesheet" type="text/css" href="lib/css/custom_new.css">
    
    <script type="text/javascript" src="lib/js/d3.js"></script>
    <script type="text/javascript" src="lib/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="lib/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="lib/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="lib/js/math.min.js"></script>
    <script type="text/javascript" src="lib/jqwidgets/jqx-all.js"></script>
</head>


<body style="width: 100%; height: 100%;">
	
<div id="tooltip1" class="hidden"><p><span id="value"></div>

<div id="container-id-1" style="width: 100%; height: 100%; clear: both;">
	<div id="dashboard" class="sidebar_wrapper" style="float: left; width: 300px; height: 1000px; overflow: hidden; display: block; border-right: 1px solid grey;">
		<div class="title_section">
			<img class="title_image" src="logo.jpg" alt="" style="width: 290px; margin-left: 2px; margin-top: 5px;">
		</div>
		
		<div class="reorder_section" style="margin: 1px; margin-top: 10px; padding:2px; font-size: 11px; border: 0.5px solid grey;">
			<div id='jqxWidget'><label>Select the Genomes for visualization: </label><div id="listbox"></div></div>
			
			<div class="opacity_slider_container" style="margin-top: 5px;">
				<div ><label for="cutoffAmount">Max distance &lt;= </label><input type="text" value="1" id="cutoffAmount" readonly style="border:0; font-weight:bold; width: 50px;"></div>
				<div id="cutoffSlider" style="width: 290px;"></div>
			</div>
			<div class="btn-group gene_search_button" data-toggle="buttons" style="margin-top: 10px;">
				<div><button id="okBtn" class="sidebar_text btn btn-primary submit_gene_button" type="button" disabled="true" onclick="updateData()" style="float: left; padding-top: 6px; padding-bottom: 6px;">OK</button></div>
			</div>
		</div>
	</div>
	<div id="vizcontainer" style="float: left; height: 1000px; ">
		<svg id="heatCanvas"></svg> 
	</div>

</div>


<footer id="footer_div" class="footer navbar-fixed-bottom">
    <div class="row"><div class="col-xs-12 footer_section"><p class="text-muted">Copyright (C) 2016 Yang Lu &lt;<a href="mailto:ylu465@usc.edu">ylu465@usc.edu</a>&gt; @ Computational and Molecular Biology, Department of Biological Science, University of Southern California, LA, CA 90089, USA </p></div></div>
</footer>

<script type="text/javascript">
	var margin = {top: 200, right: 10, bottom: 10, left: 200};
   var colors = ['#91003F','#9B1A53','#A63467','#B14F7C','#BB6990','#C684A4','#D19EB9','#DBB9CD','#E6D3E1','#F1EEF6','#FFFFFF'];
   
   var genomeNameIdxMap = new Object();   
   var cutoff = 1;
   var checkedGenomeIdxArr = [], checkedGenomeArr = [], edgeData =[];
   var genomeNameArr = ["AJ609634.fasta", "DQ113772.fasta", "HE978309.fasta", "HM563683.fasta", "HQ225832.fasta", "JN662425.fasta", "JQ182731.fasta", "JQ740801.fasta", "KF733017.fasta", "KJ094032.fasta", "KM101122.fasta", "KM581061.fasta"];
	var genomeMat = [[0.380042,0.365838,0.376618,0.417942,0.385224,0.346127,0.310381,0.291186,0.360504,0.394903,0.381474,0.427202],
	[0.404101,0.360301,0.397023,0.457388,0.425481,0.371893,0.338542,0.294611,0.391038,0.398268,0.403873,0.455243],
	[0.409725,0.329655,0.275502,0.39889,0.35434,0.331008,0.35287,0.342907,0.375505,0.367453,0.245113,0.39426],
	[0.382827,0.392218,0.335006,0.376165,0.384926,0.317622,0.309711,0.305799,0.313303,0.343896,0.327145,0.422487],
	[0.469585,0.424209,0.3658,0.235675,0.283855,0.395738,0.430005,0.449732,0.42993,0.448673,0.362741,0.298311],
	[0.431937,0.41894,0.349588,0.248564,0.256872,0.40322,0.386166,0.406856,0.359871,0.439219,0.349578,0.194262],
	[0.427408,0.27969,0.201858,0.351152,0.289394,0.257706,0.342846,0.339663,0.389321,0.335096,0.191062,0.353262],
	[0.382243,0.370128,0.386685,0.465323,0.439949,0.371497,0.303907,0.313319,0.354086,0.41129,0.389792,0.472607],
	[0.429418,0.366638,0.412671,0.495793,0.484959,0.374647,0.275048,0.295816,0.326191,0.401654,0.409769,0.486915],
	[0.419611,0.373756,0.403949,0.486992,0.452008,0.411569,0.387189,0.33097,0.406106,0.356655,0.414359,0.459025],
	[0.410006,0.368996,0.339941,0.301404,0.321865,0.400137,0.392993,0.409963,0.400295,0.382809,0.335413,0.295057],
	[0.442277,0.463858,0.375951,0.272766,0.296809,0.44915,0.445172,0.475644,0.425621,0.482002,0.37584,0.247474]];

   for(var genomeIdx=0; genomeIdx<genomeNameArr.length; genomeIdx++) genomeNameIdxMap[genomeNameArr[genomeIdx]] = genomeIdx;
   console.log("genome info finish loading!");
   
   $(function() { $( "#cutoffSlider" ).slider({ value:1, min: 0, max: 1, step: 0.01, slide: function( event, ui ) { $( "#cutoffAmount" ).val( ui.value ); cutoff = ui.value; } }); });
   
   $("#listbox").jqxListBox({width: 290, height: 600, source: genomeNameArr, checkboxes: true, filterable: true});
		$("#listbox").on('checkChange', function (event) {
			var items = $("#listbox").jqxListBox('getCheckedItems');
			checkedGenomeIdxArr = []; checkedGenomeArr = [];
			$.each(items, function (index) { checkedGenomeIdxArr.push(this.index); checkedGenomeArr.push(this.label); });
			
			if(checkedGenomeIdxArr.length > 0) $("#okBtn").prop('disabled', false);
			else $("#okBtn").prop('disabled', true);
   });
   
   
	var minDist = 1, maxDist = 0, gap=0;
	for(var rowIdx=0; rowIdx<genomeMat.length; rowIdx++) 
	{
		for(var colIdx=0; colIdx<genomeMat[0].length; colIdx++)
		{
			if(genomeMat[rowIdx][colIdx]<minDist) minDist = genomeMat[rowIdx][colIdx];
			if(genomeMat[rowIdx][colIdx]>maxDist) maxDist = genomeMat[rowIdx][colIdx];
		}
	}
	minDist = Math.max(0,minDist-0.1); maxDist = Math.min(1,maxDist+0.1); gap = maxDist-minDist;
	var colorScale = d3.scale.quantile().domain([minDist,maxDist]).range(colors);
	
	
	console.log("container-id-1 width: " + $("#container-id-1").width());
	console.log("dashboard width: " + $("#dashboard").width());
	console.log("vizcontainer width: " + $("#vizcontainer").width());
	
	containerWidth = $("#container-id-1").width()-$("#dashboard").width()-100;
	$("#vizcontainer").css("width", containerWidth);

	function updateData() {
		
		edgeData =[];
		for(var rowIdx=0; rowIdx<checkedGenomeIdxArr.length; rowIdx++) {
			for(var colIdx=0; colIdx<checkedGenomeIdxArr.length; colIdx++) {
				
				edgeData.push({"row":rowIdx, "col":colIdx, 
				"value":genomeMat[checkedGenomeIdxArr[rowIdx]][checkedGenomeIdxArr[colIdx]]<=cutoff?genomeMat[checkedGenomeIdxArr[rowIdx]][checkedGenomeIdxArr[colIdx]]:1});
				
			}
		}
	
		var cellSize = 25, legendElementWidth = cellSize*2, 
			width = Math.max(checkedGenomeIdxArr.length*cellSize, containerWidth ), height = Math.max(checkedGenomeIdxArr.length*cellSize, 1000 );
		
		
		d3.selectAll(".canvasSvg").remove(); 
		var svg = d3.select("#heatCanvas").style("float", "left").attr("width", width).attr("height", height)
			.append("g").attr('class', "canvasSvg").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
		var rowLabels = svg.append("g").selectAll(".rowLabelg").data(checkedGenomeArr).enter().append("text")
			.text(function (d) { return d; }).attr("x", 0).attr("y", function (d, i) { return i * cellSize; })
      		.style("text-anchor", "end").attr("transform", "translate(-6," + cellSize / 1.5 + ")")
      		.attr("class", function (d,i) { return "rowLabel mono r"+i;} ) ;
      		
      	var colLabels = svg.append("g").selectAll(".colLabelg").data(checkedGenomeArr).enter().append("text")
      		.text(function (d) { return d; }).attr("x", 0).attr("y", function (d, i) { return i * cellSize; })
      		.style("text-anchor", "left").attr("transform", "translate("+cellSize/2 + ",-6) rotate (-90)")
      		.attr("class",  function (d,i) { return "colLabel mono c"+i;} );
      	
      	var heatMap = svg.append("g").attr("class","g3").selectAll(".cellg").data(edgeData).enter().append("rect")
			.attr("x", function(d) { return d.col * cellSize; }).attr("y", function(d) { return d.row * cellSize; })
        	.attr("class", function(d){return "cell cell-border cr"+(d.row)+" cc"+(d.col);})
        	.attr("width", cellSize).attr("height", cellSize).style("fill", function(d) { return colorScale(d.value); })
			.on("mouseover", function(d){
				d3.selectAll(".cell").filter(function(el) {return d.row == el.row || d.col == el.col; }).classed("cell-hover",true);
				d3.selectAll(".rowLabel").classed("text-highlight",function(r,ri){ return ri==d.row;});
				d3.selectAll(".colLabel").classed("text-highlight",function(c,ci){ return ci==d.col;});
				
				d3.select("#tooltip1").style("left", (d3.event.pageX+10) + "px").style("top", (d3.event.pageY-10) + "px")
					.html("distance:"+d.value);  
                d3.select("#tooltip1").classed("hidden", false);
			})
			.on("mouseout", function(d){
				d3.selectAll(".cell").filter(function(el) {return d.row == el.row || d.col == el.col; }).classed("cell-hover",false);
				d3.selectAll(".rowLabel").classed("text-highlight",false);
				d3.selectAll(".colLabel").classed("text-highlight",false);
				d3.select("#tooltip1").classed("hidden", true);
			});
      		
      	var legend = svg.selectAll(".legend").data([minDist,minDist+0.1*gap,minDist+0.2*gap,minDist+0.3*gap,minDist+0.4*gap,minDist+0.5*gap,minDist+0.6*gap,minDist+0.7*gap,minDist+0.8*gap,minDist+0.9*gap,maxDist]).enter().append("g").attr("class", "legend");
		legend.append("rect").attr("x", function(d, i) { return legendElementWidth * i-margin.left; }).attr("y", (cellSize*2) - margin.top)
    		.attr("width", legendElementWidth).attr("height", cellSize)
    		.style("fill", function(d, i) { return colors[i]; });
    
    	legend.append("text").text(function(d) { return d3.format(".2f")(d); }).style("text-anchor", "left")
    		.attr("x", function(d, i) { return legendElementWidth * i-margin.left; }).attr("y", (cellSize*4)- margin.top);
	}
	
	

</script>

</body>
</html>